<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Explanation and Reasoning - NeuroSymbolic STEM Tutor</title>
    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"></script>
    <style>
      :root {
        --primary-color: #4a90e2;
        --primary-color-dark: #357abd;
        --background-color: #f0f4fa;
        --text-color: #222;
        --neural-bg: #e7f3fe;
        --reasoning-bg: #fff9e6;
        --justification-bg: #d4edda;
        --shadow-light: rgba(74, 144, 226, 0.25);
        --font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        font-family: var(--font-family);
        margin: 2rem;
        background: var(--background-color);
        color: var(--text-color);
        user-select: none;
      }

      h1 {
        color: var(--primary-color-dark);
        user-select: text;
      }

      .container {
        background: white;
        padding: 1.8rem;
        border-radius: 10px;
        box-shadow: 0 8px 20px var(--shadow-light);
        max-width: 700px;
        margin: auto;
      }

      .section {
        margin-bottom: 2.5rem;
      }

      label {
        font-weight: 700;
        display: block;
        margin-top: 1.1rem;
        margin-bottom: 0.6rem;
        color: var(--primary-color-dark);
        user-select: text;
      }

      textarea {
        width: 100%;
        box-sizing: border-box;
        font-family: monospace;
        padding: 0.65rem;
        font-size: 1rem;
        border-radius: 7px;
        border: 1.5px solid #a8b9d9;
        resize: vertical;
        transition: border-color 0.3s ease;
        color: var(--text-color);
      }
      textarea:focus {
        outline: none;
        border-color: var(--primary-color-dark);
        box-shadow: 0 0 10px var(--shadow-light);
        background-color: #f0f8ff;
      }

      button {
        background: var(--primary-color);
        border: none;
        color: white;
        padding: 0.55rem 1.25rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 700;
        transition: background-color 0.3s ease;
        user-select: auto;
        margin-right: 0.5rem;
        margin-top: 0.5rem;
      }
      button:hover,
      button:focus {
        background: var(--primary-color-dark);
        outline: none;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .explanation-box {
        background: var(--neural-bg);
        border-left: 6px solid var(--primary-color);
        padding: 1rem 1.2rem;
        margin-top: 1rem;
        line-height: 1.6;
        color: var(--primary-color-dark);
        user-select: text;
        border-radius: 6px;
        min-height: 50px;
      }

      .reasoning-path {
        padding: 1rem 1.2rem;
        background: var(--reasoning-bg);
        border: 2px dashed #ffc107;
        margin-top: 1rem;
        font-family: monospace;
        white-space: pre-wrap;
        color: #9a6a00;
        border-radius: 6px;
        user-select: text;
        min-height: 80px;
      }

      .justification {
        background: var(--justification-bg);
        border-left: 6px solid #28a745;
        padding: 1rem 1.2rem;
        margin-top: 1rem;
        line-height: 1.6;
        color: #256028;
        user-select: text;
        border-radius: 6px;
        min-height: 50px;
      }

      #loadingMessage {
        margin-top: 12px;
        font-style: italic;
        color: var(--primary-color-dark);
        display: none;
      }

      .model-status {
        background: #e8f5e8;
        padding: 0.8rem;
        border-radius: 6px;
        margin-top: 1rem;
        border-left: 4px solid #28a745;
        font-weight: 500;
      }

      .confidence-bar {
        background: #f0f0f0;
        height: 8px;
        border-radius: 4px;
        margin-top: 0.5rem;
        overflow: hidden;
      }

      .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-color-dark));
        transition: width 0.5s ease;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß† NeuroSymbolic STEM Tutor</h1>
      
      <div class="model-status" id="modelStatus">
        üîÑ Loading AI models... (First time takes ~30 seconds)
      </div>

      <div class="section">
        <label for="studentInput">Enter your math answer or problem step:</label>
        <textarea
          id="studentInput"
          placeholder="Example: '2x + 3 = 7, so x = 2' or 'Area of triangle = 1/2 * base * height'"
          rows="4"
        ></textarea>
        <button id="analyzeBtn" disabled>ü§ñ Analyze & Explain</button>
        <button id="clearBtn">üóëÔ∏è Clear</button>
        <div id="loadingMessage">ü§î Analyzing with NeuroSymbolic AI...</div>
      </div>

      <div id="outputSection" style="display: none">
        <div class="section">
          <h2 style="color: var(--primary-color-dark)">üß¨ Neural Feedback</h2>
          <div id="neuralFeedback" class="explanation-box"></div>
          <div id="confidenceBar" class="confidence-bar" style="display: none">
            <div class="confidence-fill" style="width: 0%"></div>
          </div>
        </div>
        <div class="section">
          <h2 style="color: var(--primary-color-dark)">
            üîç Symbolic Reasoning Path
          </h2>
          <pre id="reasoningPath" class="reasoning-path"></pre>
        </div>
        <div class="section">
          <h2 style="color: var(--primary-color-dark)">
            ‚úÖ Justification & Next Steps
          </h2>
          <div id="justification" class="justification"></div>
        </div>
      </div>
    </div>

    <script>
      // Global state
      let analyzer = null;
      let isModelLoaded = false;
      const analyzeBtn = document.getElementById("analyzeBtn");
      const clearBtn = document.getElementById("clearBtn");
      const studentInput = document.getElementById("studentInput");
      const outputSection = document.getElementById("outputSection");
      const neuralFeedback = document.getElementById("neuralFeedback");
      const reasoningPath = document.getElementById("reasoningPath");
      const justification = document.getElementById("justification");
      const loadingMessage = document.getElementById("loadingMessage");
      const modelStatus = document.getElementById("modelStatus");
      const confidenceBar = document.getElementById("confidenceBar");

      // Math pattern recognition and symbolic rules
      const mathRules = {
        algebra: {
          patterns: [
            /x\s*=\s*(\d+(?:\.\d+)?)/i,
            /(\d+(?:\.\d+)?)\s*x\s*=\s*(\d+(?:\.\d+)?)/i,
            /2x\s*=\s*(\d+)/i,
            /x\s*\+\s*(\d+)\s*=\s*(\d+)/i
          ],
          correctExamples: [
            "x = 2", "x = 3.5", "2x = 4", "x + 3 = 7"
          ]
        },
        geometry: {
          patterns: [
            /area\s*(?:of\s*)?(?:triangle|tri)?\s*=\s*(?:1\/2|0\.5)\s*\*\s*base\s*\*\s*height/i,
            /perimeter\s*=\s*2\s*\(\s*length\s*\+\s*width\s*\)/i,
            /circumference\s*=\s*2\s*œÄ\s*r/i
          ]
        },
        arithmetic: {
          patterns: [
            /(\d+)\s*\*\s*(\d+)\s*=\s*(\d+)/i,
            /(\d+)\s*\+\s*(\d+)\s*=\s*(\d+)/i
          ]
        }
      };

      // Initialize NeuroSymbolic analyzer
      async function initAnalyzer() {
        try {
          modelStatus.textContent = "üîÑ Loading Transformer models...";
          
          // Load a lightweight sentiment/quality analyzer
          analyzer = await window.Transformers.task('text-classification', 'Xenova/distilbert-base-uncased-finetuned-sst-2-english', {
            progress_callback: (data) => {
              if (data.status === 'downloading') {
                modelStatus.textContent = `üì• Downloading model... ${Math.round(data.downloaded / data.total * 100)}%`;
              }
            }
          });

          modelStatus.innerHTML = '‚úÖ <strong>AI Models Loaded!</strong> Ready for NeuroSymbolic analysis.';
          modelStatus.className = 'model-status';
          analyzeBtn.disabled = false;
          isModelLoaded = true;
        } catch (error) {
          modelStatus.innerHTML = '‚ùå Failed to load AI models. Using rule-based analysis.';
          console.error('Model loading failed:', error);
          analyzeBtn.disabled = false;
          isModelLoaded = false;
        }
      }

      // Analyze student input with NeuroSymbolic approach
      async function analyzeStudentInput(input) {
        // Neural component: Quality assessment
        let neuralScore = 0.5;
        let neuralFeedbackText = "Analysis complete. Checking mathematical validity...";
        
        if (isModelLoaded && analyzer) {
          try {
            const result = await analyzer(input);
            neuralScore = result[0].score;
            const sentiment = result[0].label === 'POSITIVE' ? 'clear and correct' : 'needs improvement';
            neuralFeedbackText = `Neural analysis: Your input appears ${sentiment} (confidence: ${(neuralScore*100).toFixed(1)}%)`;
          } catch (e) {
            console.warn('Neural analysis failed:', e);
          }
        }

        // Symbolic reasoning component
        const symbolicAnalysis = analyzeSymbolically(input);
        
        // Combine NeuroSymbolic results
        const confidence = Math.max(neuralScore * 0.6 + symbolicAnalysis.confidence * 0.4, 0.3);
        
        return {
          neuralFeedback: neuralFeedbackText,
          reasoningPath: symbolicAnalysis.reasoningPath,
          justification: symbolicAnalysis.justification,
          confidence: confidence
        };
      }

      // Symbolic mathematical analysis
      function analyzeSymbolically(input) {
        input = input.toLowerCase().trim();
        
        let reasoningSteps = [];
        let isCorrect = false;
        let confidence = 0.3;
        let justification = "Let's verify this step together.";
        
        // Check algebra patterns
        for (const [category, rules] of Object.entries(mathRules)) {
          for (const pattern of rules.patterns) {
            if (pattern.test(input)) {
              reasoningSteps.push(`‚úÖ Detected ${category} pattern match`);
              confidence += 0.25;
              isCorrect = true;
              break;
            }
          }
        }
        
        // Check common correct answers
        if (mathRules.algebra.correctExamples.some(ex => input.includes(ex.toLowerCase()))) {
          reasoningSteps.push(`‚úÖ Standard algebraic solution detected`);
          confidence += 0.3;
          isCorrect = true;
        }
        
        // Additional validation
        if (/area\s*triangle/i.test(input) && /1\/2|0\.5/i.test(input)) {
          reasoningSteps.push(`‚úÖ Correct triangle area formula`);
          confidence += 0.2;
        }
        
        if (/x\s*=\s*-?\d+(?:\.\d+)?/i.test(input)) {
          reasoningSteps.push(`‚úÖ Valid x solution format`);
          confidence += 0.15;
        }
        
        reasoningSteps.push(`Confidence score: ${(confidence*100).toFixed(0)}%`);
        
        if (confidence > 0.7) {
          justification = "Excellent! This step is mathematically correct. Continue to the next step.";
        } else if (confidence > 0.4) {
          justification = "Good attempt! Minor adjustments needed. Check the symbolic reasoning above.";
        } else {
          justification = "This step needs correction. Review the reasoning path and try again.";
        }
        
        return {
          reasoningPath: reasoningSteps.join('\n'),
          justification: justification,
          confidence: confidence,
          isCorrect: isCorrect
        };
      }

      // Event handlers
      analyzeBtn.addEventListener("click", async () => {
        const input = studentInput.value.trim();
        if (!input) {
          alert("Please enter a math problem or answer step.");
          return;
        }

        // Show loading
        loadingMessage.style.display = "block";
        outputSection.style.display = "none";
        analyzeBtn.disabled = true;

        try {
          const result = await analyzeStudentInput(input);
          
          // Update UI
          neuralFeedback.textContent = result.neuralFeedback;
          reasoningPath.textContent = result.reasoningPath;
          justification.textContent = result.justification;
          
          // Confidence visualization
          const confidencePercent = Math.round(result.confidence * 100);
          confidenceBar.style.display = "block";
          confidenceBar.querySelector('.confidence-fill').style.width = `${confidencePercent}%`;
          
          outputSection.style.display = "block";
          loadingMessage.style.display = "none";
          
        } catch (error) {
          console.error('Analysis error:', error);
          loadingMessage.textContent = "Analysis failed. Using basic validation...";
          setTimeout(() => {
            loadingMessage.style.display = "none";
          }, 2000);
        } finally {
          analyzeBtn.disabled = false;
        }
      });

      clearBtn.addEventListener("click", () => {
        studentInput.value = "";
        outputSection.style.display = "none";
        confidenceBar.style.display = "none";
        neuralFeedback.textContent = "";
        reasoningPath.textContent = "";
        justification.textContent = "";
      });

      // Initialize on page load
      window.addEventListener('DOMContentLoaded', initAnalyzer);
      
      // Keyboard shortcuts
      studentInput.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
          analyzeBtn.click();
        }
      });
    </script>
  </body>
</html>
